{% extends 'base.html' %}

{% block title %}–û–ø—Ä–æ—Å—ã ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<h2 class="text-xl font-semibold mb-4">–û–ø—Ä–æ—Å—ã</h2>

{% if user.userprofile.role == 'faculty_admin' or user.userprofile.role == 'department_admin' %}
    <div class="mb-4 text-sm text-gray-600">
        {% if user.userprofile.faculty %}
            <p>üë§ –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞: <strong>{{ user.userprofile.faculty.name }}</strong></p>
        {% endif %}
        {% if user.userprofile.department %}
            <p>üë§ –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–∞—Ñ–µ–¥—Ä—ã: <strong>{{ user.userprofile.department.name }}</strong></p>
        {% endif %}
    </div>
{% endif %}

<form method="get" class="mb-6 w-full">
  <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å –∞–≤—Ç–æ–ø–æ–∏—Å–∫–æ–º -->
  <div class="w-full pb-2 overflow-visible">
  <div class="flex flex-wrap gap-4">
    <div class="min-w-[220px]">
      <label for="filter-year">–ì–æ–¥:</label>
      <select id="filter-year" name="year" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for y in all_years %}
          <option value="{{ y }}" {% if request.GET.year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="min-w-[220px]">
      <label for="filter-name">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
      <select id="filter-name" name="name" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for n in all_names %}
          <option value="{{ n }}" {% if request.GET.name == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="min-w-[220px]">
      <label for="filter-subject">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:</label>
      <select id="filter-subject" name="subject" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for s in all_subjects %}
          <option value="{{ s }}" {% if request.GET.subject == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="min-w-[220px]">
      <label for="filter-teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
      <select id="filter-teacher" name="teacher" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for t in all_teachers %}
          <option value="{{ t }}" {% if request.GET.teacher == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="min-w-[220px]">
      <label for="filter-group">–ì—Ä—É–ø–ø–∞:</label>
      <select id="filter-group" name="group" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for g in all_groups %}
          <option value="{{ g }}" {% if request.GET.group == g %}selected{% endif %}>{{ g }}</option>
        {% endfor %}
      </select>
    </div>

    {% if user.userprofile.role == 'admin' or user.userprofile.role == 'faculty_admin' %}
    <div class="min-w-[220px]">
      <label for="filter-dept">–ö–∞—Ñ–µ–¥—Ä–∞:</label>
      <select id="filter-dept" name="department" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for d in all_departments %}
          <option value="{{ d }}" {% if request.GET.department == d %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    {% if user.userprofile.role == 'admin' %}
    <div class="min-w-[220px]">
      <label for="filter-faculty">–§–∞–∫—É–ª—å—Ç–µ—Ç:</label>
      <select id="filter-faculty" name="faculty" class="tom border rounded px-2 py-1 w-full">
        <option value="">–í—Å–µ</option>
        {% for f in all_faculties %}
          <option value="{{ f }}" {% if request.GET.faculty == f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>
</div>


  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div class="mt-4 flex gap-4 justify-start">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <a href="{% url 'admin_results' %}" class="px-4 py-2 border rounded bg-gray-100 hover:bg-gray-200">–°–±—Ä–æ—Å–∏—Ç—å</a>
  </div>
</form>

<table class="min-w-full border border-gray-300 text-sm">
    <thead>
        <tr class="bg-gray-100 text-left">
            <th class="p-2 border">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th class="p-2 border">–ì–æ–¥</th>
            <th class="p-2 border">–§–∞–∫—É–ª—å—Ç–µ—Ç</th>
            <th class="p-2 border">–ö–∞—Ñ–µ–¥—Ä–∞</th>
            <th class="p-2 border">–ü—Ä–µ–¥–º–µ—Ç</th>
            <th class="p-2 border">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
            <th class="p-2 border">–ì—Ä—É–ø–ø–∞</th>
            <th class="p-2 border">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</th>
            <th class="p-2 border">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</th>
            <th class="p-2 border">–í–∑–≤–µ—à–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞</th>
        </tr>
    </thead>
    <tbody>
        {% for s in surveys %}
        <tr class="hover:bg-gray-50">
            <td class="p-2 border">{{ s.name }}</td>
            <td class="p-2 border">{{ s.year }}</td>
            <td class="p-2 border">{{ s.teacher_subject.teacher.department.faculty.name }}</td>
            <td class="p-2 border">{{ s.teacher_subject.teacher.department.name }}</td>
            <td class="p-2 border">{{ s.teacher_subject.subject.name }}</td>
            <td class="p-2 border">{{ s.teacher_subject.teacher.full_name }}</td>
            <td class="p-2 border">{{ s.teacher_subject.group }} </td>
            <td class="p-2 border">
                <a href="{% url 'survey_results' s.id %}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                    –°–º–æ—Ç—Ä–µ—Ç—å
                </a>
            </td>
            <td class="p-2 border">{{ s.avg_score|default:"‚Äì" }}</td>
            <td class="p-2 border">{{ s.weighted_score|default:"‚Äì" }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="10" class="text-gray-500 italic p-3">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
